<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 채팅방 테이블과 참여자 테이블에 대한 매퍼(room, room_user) -->
<mapper namespace="room">
	
	<!-- 채팅방 번호 시퀀스 -->
	<select id="sequence" resultType="long">
		select room_seq.nextval from dual
	</select>
	
	<!-- 채팅방 생성 -->
	<insert id="insert">
		insert into room(room_no, room_title, room_owner)
		values(
			#{roomNo}, #{roomTitle}, #{roomOwner}
		)
	</insert>
	
	
	<!-- 채팅방 목록 조회 (현재 로그인한 사용자가 속한 방만) -->

	<select id="listByMember" resultType="RoomDto">
		select * from room where room_owner = #{memberNo}

	</select>
	
	<!-- 특정 채팅방 조회 -->
	<select id="find" resultType="RoomDto">
		select room_no, room_title, room_owner
		from room
		where room_no = #{roomNo}
	</select>
	
	<!-- 채팅방 삭제 -->
	<delete id="delete">
		delete from room where room_no = #{roomNo}
	</delete>
	
	<!-- 채팅방 입장 -->
	<insert id="enter">
		insert into room_user(room_no, member_no)
		values(
			#{roomNo}, #{memberNo}
		)
	</insert>
	
	<!-- 채팅방 중복 입장 방지 -->
	<select id="check" resultType="int">
		select count(*) from room_user
		where room_no = #{roomNo} and member_no = #{memberNo}
	</select>
	
	<!-- 채팅방의 모든 유저 조회 -->
	<select id="getUsers" resultType="UserVO">
		select
            member_no as memberNo, 
            member_name as memberName, 
            member_department as memberDepartment
        from room_user, member
        where room_user.member_no = member.member_no
        and room_user.room_no = #{roomNo}
        order by member_name asc
	</select>
	
	<!-- 채팅방 나가기 -->
	<delete id="leave">
		delete from room_user
		where room_no = #{roomNo} and member_no = #{memberNo}
	</delete>
	
	<!-- 채팅방 멤버 추가 -->
	<insert id="addMembers">
	    <foreach collection="memberNos" item="memberNo" separator="," >
	        insert into room_user(room_no, member_no) 
	        values(#{roomNo}, #{memberNo})
	    </foreach>
	</insert>
	
</mapper>
